/* Copyright (c) 2023, Canaan Bright Sight Co., Ltd
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 as
 * published by the Free Software Foundation.
*/

#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/platform_device.h>
#include <linux/of.h>
#include <linux/of_device.h>
#include <linux/device.h>
#include <linux/io.h>
#include <linux/crypto.h>
#include <crypto/skcipher.h>
#include <crypto/internal/skcipher.h>
#include <crypto/scatterwalk.h>
#include <crypto/algapi.h>
#include "kendryte-rsa.h"

struct kendryte_rsa_dev rsa_device;
static uint8_t pkc_buffer[PKC_BUFFER_SIZE];

//----------------------BASE FUNCTION ----------------------------------------//
void reverse(uint8_t* dst, const uint8_t* src, size_t len)
{
    size_t i, j;
    for (i=0,j=len-1; i<len; i++,j--)
        dst[i] = src[j];
}

static int16_t bn_cmp(const uint8_t* a, const uint8_t* b, uint32_t len)
{
    uint32_t i;
    for (i=0; i<len; i++)
    {
        if (a[i] == b[i])
            continue;
        return ((int16_t)(a[i]) - (int16_t)(b[i]));
    }
    return 0;
}

static void* rsa_memcpy(void * dest,const void *src,int count)
{
    uint32_t *tmp = (uint32_t *) dest, *s = (uint32_t *) src;
    int c = count / 4;
    while (c--)
            *tmp++ = *s++;

    return dest;
}

static void read_ecp_operand(struct kendryte_rsa_ctx *ctx, uint32_t pos, uint8_t* res, uint32_t elen)
{
    uint32_t wlen = ((elen + 3) / 4) * 4;
    uint32_t rlen = wlen;

    rsa_memcpy(pkc_buffer, (uint8_t *)(ctx->dev->base + ECP_DATA_OFFSET) + wlen * pos, rlen);
    reverse(res, pkc_buffer, elen);
}

static void write_ecp_operand(struct kendryte_rsa_ctx *ctx, uint32_t pos, const uint8_t *op, uint32_t elen)
{
    uint32_t wlen = ((elen + 3) / 4) * 4;
    memset(pkc_buffer, 0, wlen);
    if (op != NULL)
        reverse(pkc_buffer, op, elen);
    rsa_memcpy((uint8_t *)(ctx->dev->base + ECP_DATA_OFFSET) + wlen * pos, pkc_buffer, wlen);
}

static kendryte_status_t rsa_get_field_elen(kendryte_ecp_field_t *field, uint32_t *elen, kendryte_rsa_type_t rsatype)
{
    kendryte_ecp_field_t rf;
    uint32_t rl;

    switch(rsatype)
    {
        case RSA1024:
            rf = P1024; rl = 128; break;
        case RSA2048:
            rf = P2048; rl = 256; break;
        case RSA3072:
            rf = P3072; rl = 384; break;
        case RSA4096:
            rf = P4096; rl = 512; break;
        default:
            return E_INVALID;
    }

    if (field != NULL)
        *field = rf;
    if (elen != NULL)
        *elen = rl;
    return SUCCESS;
}

//----------------------RSA MICRO PROGRAMS FUNCTION ----------------------------------------//
/**
 * @brief RSA micro programs for ECF39303-00000000
 */
static kendryte_rsa_mprog_func_st prog_ECF39303_RSA1024 =
{
    .prk = "\x40\x00\x00\x8a\x60\x40\x04\x0a\x80\x80\x08\x8a\xa0\xc0\x0c\x0a\x00\x04\x11\x26\x40\x40\x15\x26\x00\x0c\x80\x43\x66\x10\x10\x88\x00\x00\x00\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00",
    .puk = "\x40\x00\x00\x8a\x80\x80\x08\x8a\x00\x0b\x80\xc3\x66\x10\x10\x88\x00\x00\x00\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00",
};

static kendryte_rsa_mprog_func_st prog_ECF39303_RSA2048 =
{
    .prk = "\x40\x00\x00\x8a\x80\x40\x08\x8a\xc0\x80\x10\x0a\x00\xc1\x18\x8a\x00\x08\x21\x26\x40\x40\x29\x26\x00\x0c\x80\x43\xc6\x10\x18\x08\x00\x00\x00\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00",
    .puk = "\x40\x00\x00\x8a\xc0\x80\x10\x0a\x00\x0b\x80\xc3\xc6\x10\x18\x08\x00\x00\x00\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00",
};

static kendryte_rsa_mprog_func_st prog_ECF39303_RSA3072 =
{
    .prk = "\x40\x00\x00\x8a\xa0\x40\x0c\x8a\x00\x81\x18\x0a\x60\xc1\x24\x8a\x00\x0c\x31\x26\x40\x40\x3d\x26\x00\x0c\x80\x43\x26\x11\x20\x88\x00\x00\x00\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00",
    .puk = "\x40\x00\x00\x8a\x00\x81\x18\x0a\x00\x0b\x80\xc3\x26\x11\x20\x88\x00\x00\x00\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00",
};

static kendryte_rsa_mprog_func_st prog_ECF39303_RSA4096 =
{
    .prk = "\x40\x00\x00\x8a\xc0\x40\x10\x0a\x40\x81\x20\x0a\xc0\xc1\x30\x8a\x00\x10\x41\x26\x40\x40\x51\x26\x00\x0c\x80\x43\x86\x11\x28\x08\x00\x00\x00\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00",
    .puk = "\x40\x00\x00\x8a\x40\x81\x20\x0a\x00\x0b\x80\xc3\x86\x11\x28\x08\x00\x00\x00\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00",
};

/**
 * @brief RSA micro programs for ECF09303-00000000
 */
static kendryte_rsa_mprog_func_st prog_ECF09303_RSA1024 =
{
    .prk = "\x88\x00\x00\x8e\x40\x00\x00\x8a\x80\x80\x08\x8a\xa0\x40\x04\x0a\x00\x04\x11\x26\x40\x40\x15\x26\x00\x0c\x80\x43\x66\x10\x10\x88\x00\x00\x00\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00",
    .puk = "\x40\x00\x00\x8a\x80\x80\x08\x8a\x00\x0b\x80\xc3\x66\x10\x10\x88\x00\x00\x00\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00",
};

static kendryte_rsa_mprog_func_st prog_ECF09303_RSA2048 =
{
    .prk = "\x08\x01\x00\x8e\x40\x00\x00\x8a\xc0\x80\x10\x0a\x00\x41\x08\x8a\x00\x08\x21\x26\x40\x40\x29\x26\x00\x0c\x80\x43\xc6\x10\x18\x08\x00\x00\x00\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00",
    .puk = "\x40\x00\x00\x8a\xc0\x80\x10\x0a\x00\x0b\x80\xc3\xc6\x10\x18\x08\x00\x00\x00\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00",
};

static kendryte_rsa_mprog_func_st prog_ECF09303_RSA3072 =
{
    .prk = "\x88\x01\x00\x0e\x40\x00\x00\x8a\x00\x81\x18\x0a\x60\x41\x0c\x0a\x00\x0c\x31\x26\x40\x40\x3d\x26\x00\x0c\x80\x43\x26\x11\x20\x88\x00\x00\x00\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00",
    .puk = "\x40\x00\x00\x8a\x00\x81\x18\x0a\x00\x0b\x80\xc3\x26\x11\x20\x88\x00\x00\x00\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00",
};

static kendryte_rsa_mprog_func_st prog_ECF09303_RSA4096 =
{
    .prk = "\x08\x02\x00\x8e\x40\x00\x00\x8a\x40\x81\x20\x0a\xc0\x41\x10\x8a\x00\x10\x41\x26\x40\x40\x51\x26\x00\x0c\x80\x43\x86\x11\x28\x08\x00\x00\x00\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00",
    .puk = "\x40\x00\x00\x8a\x40\x81\x20\x0a\x00\x0b\x80\xc3\x86\x11\x28\x08\x00\x00\x00\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00",
};

/**
 * @brief CMAC of RSA micro programs for ECF39303-00000000
 */
static kendryte_rsa_mprog_cmac_st sum_ECF39303_00000000_RSA1024 =
{
    .prk = "\xc8\x41\x5c\x25\xc8\xcf\x59\xa2\x44\x36\xa1\x0d\xd9\x19\x57\xbe",
    .puk = "\x8a\x76\xb9\x4f\x91\xf0\x6b\x5f\x38\x8f\x95\xa7\xd9\x1c\xfb\xfd",
};

static kendryte_rsa_mprog_cmac_st sum_ECF39303_00000000_RSA2048 =
{
    .prk = "\xde\x95\xd0\x35\x2e\x47\x2e\x51\xce\x44\x80\x2a\x61\xbf\x9e\xf2",
    .puk = "\x81\xac\xcd\x33\x4e\x43\x17\x68\x5d\xad\x83\x42\x78\x99\x49\x27",
};

static kendryte_rsa_mprog_cmac_st sum_ECF39303_00000000_RSA3072 =
{
    .prk = "\xfe\x00\x41\x8c\xa3\xd3\x71\xe1\x0a\x74\x48\xcf\xd4\x85\x1c\xdf",
    .puk = "\x8d\x0b\x92\x7d\xa0\x90\x5a\xaf\xc2\x73\x1e\x54\x25\x57\x09\x75",
};

static kendryte_rsa_mprog_cmac_st sum_ECF39303_00000000_RSA4096 =
{
    .prk = "\x07\x68\xfa\xa9\x5e\xba\xff\xe3\xba\x8b\xa8\x8a\xaf\x47\x6b\x12",
    .puk = "\x96\x52\x20\xd0\x66\xc7\x1a\x6b\x4f\xa5\xf3\x04\x7a\x20\x87\x52",
};

/**
 * @brief CMAC of RSA micro programs for ECF09303-00000000
 */
static kendryte_rsa_mprog_cmac_st sum_ECF09303_00000000_RSA1024 =
{
    .prk = "\x81\x8e\x08\xa7\xc1\xb2\xfa\xe7\x36\x69\x2e\x5a\xaa\x08\x8c\xeb",
    .puk = "\x4f\x59\x8f\xa8\x7f\x80\x39\x73\xd2\xb3\xec\x0c\x1d\x95\x5b\x85",
};

static kendryte_rsa_mprog_cmac_st sum_ECF09303_00000000_RSA2048 =
{
    .prk = "\x53\x12\x35\x6b\x74\xf8\x6a\xb9\xc5\x48\x4c\x5e\x6b\xbb\x3e\xa3",
    .puk = "\xe1\x4c\x60\xc2\x8c\x5b\x22\xe4\x58\x7c\x17\x07\x9a\x11\x20\x8d",
};

static kendryte_rsa_mprog_cmac_st sum_ECF09303_00000000_RSA3072 =
{
    .prk = "\x0f\xd6\xa9\xd2\xe7\x3a\x71\x6e\xf4\x5e\x8d\x86\x24\xa1\xff\xbd",
    .puk = "\x13\xc4\x8d\xb1\x66\x04\xb3\xa0\x9e\xcb\x73\x63\xdf\xef\xe6\x3e",
};

static kendryte_rsa_mprog_cmac_st sum_ECF09303_00000000_RSA4096 =
{
    .prk = "\x72\x41\x3e\x33\xba\x9b\x84\x8a\x43\x12\x3c\xb0\x96\x4b\xca\xbb",
    .puk = "\x8a\x00\xac\x58\xc0\x04\x40\xc9\x1d\x81\x75\x3f\x14\x83\xec\x53",
};

/**
 * @brief group of CMAC of RSA micro programs for ECF39303
 */
static kendryte_rsa_mprog_cmac_st *gsum_ECF39303_RSA1024[] =
{
   &sum_ECF39303_00000000_RSA1024,
};

static kendryte_rsa_mprog_cmac_st *gsum_ECF39303_RSA2048[] =
{
    &sum_ECF39303_00000000_RSA2048,
};

static kendryte_rsa_mprog_cmac_st *gsum_ECF39303_RSA3072[] =
{
    &sum_ECF39303_00000000_RSA3072,
};

static kendryte_rsa_mprog_cmac_st *gsum_ECF39303_RSA4096[] =
{
    &sum_ECF39303_00000000_RSA4096,
};
 
/**
 * @brief group of CMAC of RSA micro programs for ECF09303
 */
static kendryte_rsa_mprog_cmac_st *gsum_ECF09303_RSA1024[] =
{
   &sum_ECF09303_00000000_RSA1024,
};

static kendryte_rsa_mprog_cmac_st *gsum_ECF09303_RSA2048[] =
{
    &sum_ECF09303_00000000_RSA2048,
};

static kendryte_rsa_mprog_cmac_st *gsum_ECF09303_RSA3072[] =
{
    &sum_ECF09303_00000000_RSA3072,
};

static kendryte_rsa_mprog_cmac_st *gsum_ECF09303_RSA4096[] =
{
    &sum_ECF09303_00000000_RSA4096,
};

kendryte_rsa_mprog_st rsa_ECF39303[] = 
{
    {
        .cmac = gsum_ECF39303_RSA1024,
        .func = &prog_ECF39303_RSA1024,
    },
    {
        .cmac = gsum_ECF39303_RSA2048,
        .func = &prog_ECF39303_RSA2048,
    },
    {
        .cmac = gsum_ECF39303_RSA3072,
        .func = &prog_ECF39303_RSA3072,
    },
    {
        .cmac = gsum_ECF39303_RSA4096,
        .func = &prog_ECF39303_RSA4096,
    },
};

kendryte_rsa_mprog_st rsa_ECF09303[] = 
{
    {
        .cmac = gsum_ECF09303_RSA1024,
        .func = &prog_ECF09303_RSA1024,
    },
    {
        .cmac = gsum_ECF09303_RSA2048,
        .func = &prog_ECF09303_RSA2048,
    },
    {
        .cmac = gsum_ECF09303_RSA3072,
        .func = &prog_ECF09303_RSA3072,
    },
    {
        .cmac = gsum_ECF09303_RSA4096,
        .func = &prog_ECF09303_RSA4096,
    },
};

kendryte_rsa_mprog_st* rsa_mprog[] =
{
    rsa_ECF39303,
    rsa_ECF09303,
};

//----------------------RSA FUNCTION ----------------------------------------//
/**
 * @brief Starting ECP and wait until done
 *
 * @return ECCA status register value
 */
static uint32_t kendryte_ecc_start(struct kendryte_rsa_ctx *ctx)
{
    uint32_t ret;
    writel(0x1, ctx->dev->base + ECP_CTRL_OFFSET);
    do
    {
        ret = readl(ctx->dev->base + ECP_STATUS_OFFSET);
    }while((ret & ECP_STATUS_BUSY_MASK) != 0);

    return ret;
}

static int kendryte_rsa_sign(struct skcipher_request *req)
{
    struct crypto_skcipher *tfm = crypto_skcipher_reqtfm(req);
    struct kendryte_rsa_ctx *ctx = crypto_skcipher_ctx(tfm);
    uint32_t elen = 0, val32 = 0;
    kendryte_ecp_field_t field;
    kendryte_status_t check = SUCCESS;
    void *buf_src, *buf_dst;
    const void *n, *priv, *msg;
    uint32_t puk;
    kendryte_rsa_type_t rsatype;
    kendryte_ecp_version_t ecp_version = ECP_ECF39303;
    kendryte_mp_version_t mp_version = MP_00000000;
    uint8_t out[PKC_BUFFER_SIZE];
    int ret = 0;

    if ((check = rsa_get_field_elen(&field, &elen, ctx->rsatype)) != SUCCESS)
        goto rsa_err;

    buf_src = kzalloc(elen, GFP_KERNEL);
    buf_dst = kzalloc(elen, GFP_KERNEL);
    if((NULL == buf_src) || (NULL == buf_dst))
    {
        pr_err("Could not kzalloc buffer.\n");
        ret = -1;
        goto done;
    }
    scatterwalk_map_and_copy(buf_src, req->src, 0, elen, 0);    // message
    memset(out, 0x0, PKC_BUFFER_SIZE);
    msg = buf_src;
    n = ctx->n;
    puk = ctx->e;
    priv = ctx->d;
    rsatype = ctx->rsatype;

    if(out == NULL || n == NULL || puk == 0 || priv == NULL || msg == NULL) {
        check = E_INVALID;
        goto rsa_err;
    }

    if (bn_cmp(msg, n, elen) >= 0) {
        check = E_INVALID;
        goto rsa_err;
    }

    val32 = field << ECP_ECP_EC_FIELD_BITS;
    writel(val32, ctx->dev->base + ECP_EC_OFFSET);
    writel(puk, ctx->dev->base + ECP_E_SHORT_OFFSET);
    write_ecp_operand(ctx, 0, n, elen);
    write_ecp_operand(ctx, 1, NULL, elen);
    write_ecp_operand(ctx, 2, msg, elen);
    write_ecp_operand(ctx, 3, priv, elen);

    kendryte_rsa_mprog_st *prog = &(rsa_mprog[ecp_version][rsatype]);
    kendryte_rsa_mprog_cmac_st *cmac = prog->cmac[mp_version];

    rsa_memcpy((void *)(ctx->dev->base + ECP_MAC_OFFSET), cmac->prk, ECP_MPMAC_SIZE);
    rsa_memcpy((void *)(ctx->dev->base + ECP_PROGRAM_OFFSET), prog->func->prk, ECP_MPROG_SIZE);

    val32 = kendryte_ecc_start(ctx);

    if (val32 & ECP_STATUS_MPROG_MASK) {
        check = E_ECMPROG;
        goto rsa_err;
    }

    if (val32) {
        check = E_VERFAIL;
        goto rsa_err;
    }

    read_ecp_operand(ctx, 2, out, elen);
    memcpy(buf_dst, out, elen);
    scatterwalk_map_and_copy(buf_dst, req->dst, 0, elen, 1);

    // int i;
    // for(i=0; i<elen; i++)
	// 	pr_info("[rsa]: msg = 0x%x, out[%d] = 0x%x\n", *(uint8_t*)(msg+i), i, out[i]);

    return 0;

rsa_err:
    if(check != SUCCESS) {
        pr_err("Kendryte RSA sign error-%d!\n", check);
        return -1;
    }

done:
    kfree(buf_src);
    kfree(buf_dst);
    return ret;
}

static int kendryte_rsa_verify(struct skcipher_request *req)
{
    struct crypto_skcipher *tfm = crypto_skcipher_reqtfm(req);
    struct kendryte_rsa_ctx *ctx = crypto_skcipher_ctx(tfm);
    uint32_t elen = 0, val32 = 0;
    kendryte_ecp_field_t field;
    kendryte_status_t check = SUCCESS;
    void *buf_src, *buf_dst;
    const void *n, *sig;
    uint32_t puk;
    kendryte_rsa_type_t rsatype;
    kendryte_ecp_version_t ecp_version = ECP_ECF39303;
    kendryte_mp_version_t mp_version = MP_00000000;
    uint8_t msg[PKC_BUFFER_SIZE];
    int ret = 0;

    if ((check = rsa_get_field_elen(&field, &elen, ctx->rsatype)) != SUCCESS)
        goto rsa_err;

    buf_src = kzalloc(elen, GFP_KERNEL);
    buf_dst = kzalloc(elen, GFP_KERNEL);
    if((NULL == buf_src) || (NULL == buf_dst))
    {
        pr_err("Could not kzalloc buffer.\n");
        ret = -1;
        goto done;
    }
    scatterwalk_map_and_copy(buf_src, req->src, 0, elen, 0);    // signature
    memset(msg, 0x0, PKC_BUFFER_SIZE);
    sig = buf_src;
    n = ctx->n;
    puk = ctx->e;
    rsatype = ctx->rsatype;

    if(sig == NULL || n == NULL || puk == 0) {
        check = E_INVALID;
        goto rsa_err;
    }

    if (bn_cmp(sig, n, elen) >= 0) {
        check = E_INVALID;
        goto rsa_err;
    }

    val32 = field << ECP_ECP_EC_FIELD_BITS;
    writel(val32, ctx->dev->base + ECP_EC_OFFSET);
    writel(puk, ctx->dev->base + ECP_E_SHORT_OFFSET);
    write_ecp_operand(ctx, 0, n, elen);
    write_ecp_operand(ctx, 2, sig, elen);

    kendryte_rsa_mprog_st *prog = &(rsa_mprog[ecp_version][rsatype]);
    kendryte_rsa_mprog_cmac_st *cmac = prog->cmac[mp_version];

    rsa_memcpy((void *)(ctx->dev->base + ECP_MAC_OFFSET), cmac->puk, ECP_MPMAC_SIZE);
    rsa_memcpy((void *)(ctx->dev->base + ECP_PROGRAM_OFFSET), prog->func->puk, ECP_MPROG_SIZE);

    val32 = kendryte_ecc_start(ctx);

    if (val32 & ECP_STATUS_MPROG_MASK) {
        check = E_ECMPROG;
        goto rsa_err;
    }

    if (val32) {
        check = E_VERFAIL;
        goto rsa_err;
    }

    read_ecp_operand(ctx, 2, msg, elen);
    memcpy(buf_dst, msg, elen);
    scatterwalk_map_and_copy(buf_dst, req->dst, 0, elen, 1);

    return 0;

rsa_err:
    if(check != SUCCESS) {
        pr_err("Kendryte RSA verify error-%d!\n", check);
        return -1;
    }
done:
    kfree(buf_src);
    kfree(buf_dst);
    return ret;
}

/*
    key  =     n    ||    d     ||    e     ||
          <- n_len -> <- d_len -> <- e_len ->
              128        128          4
              256        256          4
              384        384          4
              512        512          4
*/
static int kendryte_rsa_setkey(struct crypto_skcipher *tfm, const uint8_t *key, unsigned int keylen)
{
    struct kendryte_rsa_ctx *ctx = crypto_skcipher_ctx(tfm);
    int len = 0;

    ctx->key_sz = keylen;
    memcpy(ctx->key, key, keylen);
    if(keylen == (128*2+4))
    {
        len = 128;
        ctx->rsatype = RSA1024;
    }
    else if(keylen == (256*2+4))
    {
        len = 256;
        ctx->rsatype = RSA2048;
    } 
    else if(keylen == (384*2+4))
    {
        len = 384;
        ctx->rsatype = RSA3072;
    }  
    else if(keylen == (512*2+4))
    {
        len = 512;
        ctx->rsatype = RSA4096;
    }
    else
    {
        len = -1;
        ctx->rsatype = N_RSA_TYPE_T;
        return -1;
    }

    memcpy(&ctx->n, ctx->key, len);
    memcpy(&ctx->d, (ctx->key + len), len);
    memcpy(&ctx->e, (ctx->key + len * 2), 4);

    return 0;
}

static int kendryte_cra_init(struct crypto_tfm *tfm)
{
    struct kendryte_rsa_ctx *ctx = crypto_tfm_ctx(tfm);

    ctx->dev = &rsa_device;
    return 0;
}

static int kendryte_rsa_init(struct crypto_skcipher *tfm)
{
    return kendryte_cra_init(&tfm->base);
}

static struct skcipher_alg kendryte_rsa_alg = {
    .encrypt        = kendryte_rsa_verify,
    .decrypt        = kendryte_rsa_sign,
    .ivsize         = 1,
    .setkey         = kendryte_rsa_setkey,
    .min_keysize    = 0,
    .max_keysize    = 2048,
    .init           = kendryte_rsa_init,
    .base           = {
        .cra_name           = "k230-rsa",
        .cra_driver_name    = "kendryte-rsa",
        .cra_priority       = 400,
        .cra_flags          = CRYPTO_ALG_ASYNC,
        .cra_blocksize      = 64,
        .cra_ctxsize        = sizeof(struct kendryte_rsa_ctx),
        .cra_module         = THIS_MODULE,
    }
};

static int kendryte_rsa_remove(struct platform_device *pdev)
{
    crypto_unregister_skcipher(&kendryte_rsa_alg);
    return 0;
}

static int kendryte_rsa_probe(struct platform_device *pdev)
{
    struct resource *res;
    struct device *dev = &pdev->dev;
    int err = -1;

    rsa_device.dev = dev;
    res = platform_get_resource(pdev, IORESOURCE_MEM, 0);
    rsa_device.base = devm_ioremap_resource(dev, res);
    if(IS_ERR(rsa_device.base))
        return PTR_ERR(rsa_device.base);

    platform_set_drvdata(pdev, &rsa_device);

    err = crypto_register_skcipher(&kendryte_rsa_alg);
    if(err < 0)
        goto rsa_err;

    pr_info("Kendryte RSA driver probe!\n");

out:
    return err;

rsa_err:
    dev_err(&pdev->dev, "Unable to register RSA algorithm!\n");
    crypto_unregister_skcipher(&kendryte_rsa_alg);
    goto out;
}

static const struct of_device_id of_kendryte_rsa_ids[] = {
    { .compatible = "canaan,k230-rsa" },
    { }
};
MODULE_DEVICE_TABLE(of, of_kendryte_rsa_ids);

static struct platform_driver kendryte_rsa_driver = {
    .probe = kendryte_rsa_probe,
    .remove = kendryte_rsa_remove,
    .driver = {
        .name = "kendryte-rsa",
        .of_match_table = of_kendryte_rsa_ids,
    },
};
module_platform_driver(kendryte_rsa_driver);